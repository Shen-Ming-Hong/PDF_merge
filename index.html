<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF åˆä½µå·¥å…· | Pyodide + pypdf</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 1rem;
      line-height: 1.5;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #log {
      white-space: pre-line;
      background: #f7f7f7;
      padding: .5rem;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }

    .progress-container {
      width: 100%;
      background-color: #f1f1f1;
      border-radius: 4px;
      margin: 10px 0;
      display: none;
    }

    .progress-bar {
      height: 20px;
      background-color: #4CAF50;
      border-radius: 4px;
      width: 0%;
      text-align: center;
      line-height: 20px;
      color: white;
    }

    .file-list {
      margin: 10px 0;
      padding: 0;
      list-style: none;
    }

    .file-list li {
      padding: 5px;
      margin: 2px 0;
      background: #f9f9f9;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
    }

    .btn {
      background-color: #4CAF50;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #45a049;
    }

    .btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .footer {
      margin-top: 2rem;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <h1>PDF åˆä½µå·¥å…·</h1>
  <p>å®Œå…¨é›¢ç·šçš„ç€è¦½å™¨ç«¯ PDF åˆä½µå·¥å…·ï¼Œæ‚¨çš„æª”æ¡ˆä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</p>

  <div class="card">
    <h3>1. é¸æ“‡è¦åˆä½µçš„ PDF æª”æ¡ˆ</h3>
    <input id="fileInput" type="file" accept="application/pdf" multiple>
    <ul id="fileList" class="file-list"></ul>    <h3>2. åˆä½µé¸é …</h3>
    <label>
      <input type="text" id="outputFileName" value="merged_document" placeholder="è¼¸å‡ºæª”å">
      .pdf
    </label>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <button id="mergeBtn" class="btn">é–‹å§‹åˆä½µ</button>
  </div>

  <div class="card">
    <h3>è™•ç†æ—¥èªŒ</h3>
    <div id="log"></div>
  </div>

  <div class="footer">
    ä½¿ç”¨ Pyodide + pypdf åœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œï¼Œæª”æ¡ˆä¸æœƒé›¢é–‹æ‚¨çš„é›»è…¦ | <a href="https://github.com/your-username/PDF_merge" target="_blank">GitHub
      åŸå§‹ç¢¼</a>
  </div>
  <script>
    // å…¨åŸŸè®Šæ•¸
    let worker = null;
    const mergeBtn = document.getElementById("mergeBtn");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const progressBar = document.getElementById("progressBar");
    const progressContainer = document.getElementById("progressContainer");

    // åˆå§‹åŒ– Worker
    function initWorker() {
      if (worker !== null) {
        worker.terminate();
      }
      worker = new Worker("pdfMergeWorker.js");

      // è¨­ç½® worker äº‹ä»¶è™•ç†
      worker.onmessage = function (e) {
        const { type, message, data, progress } = e.data;

        switch (type) {
          case 'status':
            log(message);
            if (progress !== undefined) {
              updateProgress(progress);
            }
            break;

          case 'log':
            log(message);
            break;

          case 'initialized':
            mergeBtn.disabled = false;
            break;

          case 'error':
            log(`âŒ ${message}`);
            console.error(message);
            mergeBtn.disabled = false;
            break;

          case 'result':
            handleMergeResult(data);
            break;
        }
      };

      worker.onerror = function (error) {
        log(`âŒ Worker éŒ¯èª¤: ${error.message}`);
        console.error(error);
        mergeBtn.disabled = false;
      };

      // åˆå§‹åŒ– Pyodide
      worker.postMessage({ type: 'init' });
    }

    // è™•ç†åˆä½µçµæœ
    function handleMergeResult(outputBytes) {
      try {
        // ç²å–è¼¸å‡ºæª”å
        const outputName = document.getElementById("outputFileName").value.trim() || "merged_document";

        // å»ºç«‹ Blob ä¸¦ä¸‹è¼‰
        const blob = new Blob([outputBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${outputName}.pdf`;

        // è§¸ç™¼ä¸‹è¼‰
        a.click();
        URL.revokeObjectURL(url);
        log(`ğŸ‰ åˆä½µå®Œæˆï¼æª”æ¡ˆå·²ä¸‹è¼‰: ${outputName}.pdf (${formatFileSize(blob.size)})`);
      } catch (error) {
        log(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`);
        console.error(error);
      } finally {
        mergeBtn.disabled = false;
        updateProgress(100);
      }
    }

    // æ›´æ–°æª”æ¡ˆåˆ—è¡¨
    fileInput.addEventListener("change", () => {
      fileList.innerHTML = "";
      Array.from(fileInput.files).forEach((file, index) => {
        const li = document.createElement("li");
        li.textContent = `${index + 1}. ${file.name} (${formatFileSize(file.size)})`;
        fileList.appendChild(li);
      });
    });

    // åˆä½µæŒ‰éˆ•äº‹ä»¶
    mergeBtn.addEventListener("click", async () => {
      const files = fileInput.files;
      if (!files.length) {
        alert("è«‹å…ˆé¸æ“‡è‡³å°‘ 1 å€‹ PDFï¼");
        return;
      }

      mergeBtn.disabled = true;
      progressContainer.style.display = "block";
      updateProgress(0);
      log(`âŒ› é–‹å§‹è™•ç† ${files.length} ä»½æª”æ¡ˆ...`);

      try {
        // æº–å‚™æª”æ¡ˆè³‡æ–™
        const fileData = [];
        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          log(`âŒ› è®€å–æª”æ¡ˆ: ${f.name}`);
          const data = new Uint8Array(await f.arrayBuffer());
          fileData.push({
            name: f.name,
            data: data
          });
          updateProgress((i + 1) / files.length * 30);
        }        // ç™¼é€åˆä½µè«‹æ±‚è‡³ Worker
        worker.postMessage({          type: 'merge',
          data: {
            files: fileData
          }
        });

      } catch (error) {
        log(`âŒ æª”æ¡ˆè™•ç†å¤±æ•—: ${error.message}`);
        console.error(error);
        mergeBtn.disabled = false;
      }
    });

    // è¼”åŠ©å‡½æ•¸
    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateProgress(percent) {
      progressBar.style.width = `${percent}%`;
      progressBar.textContent = `${Math.round(percent)}%`;
      progressContainer.style.display = "block";
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
    }

    // å•Ÿå‹•æ‡‰ç”¨
    initWorker();  </script>

  <script>
    // è¨»å†Š Service Worker ä»¥æä¾›é›¢ç·šåŠŸèƒ½
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            console.log('Service Worker è¨»å†ŠæˆåŠŸï¼Œç¯„åœ: ', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker è¨»å†Šå¤±æ•—: ', error);
          });
      });
    }
  </script>
</body>

</html>