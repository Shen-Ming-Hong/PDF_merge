<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF 合併工具 | Pyodide + pypdf</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="font-sans max-w-3xl mx-auto p-4 leading-relaxed">
  <h1 class="text-2xl font-bold mb-2">PDF 合併工具</h1>
  <p class="mb-4 text-gray-700">完全離線的瀏覽器端 PDF 合併工具，您的檔案不會上傳到任何伺服器</p>

  <div class="border border-gray-300 rounded-lg p-4 mb-4 shadow">
    <h3 class="font-semibold mb-2">1. 選擇要合併的 PDF 檔案</h3>
    <input id="fileInput" class="mb-2" type="file" accept="application/pdf" multiple>
    <ul id="fileList" class="list-none my-2 p-0"></ul>
    <h3 class="font-semibold mb-2">2. 合併選項</h3>
    <label class="block mb-2">
      <input type="text" id="outputFileName" value="merged_document" placeholder="輸出檔名" class="border rounded px-2 py-1 mr-1">
      .pdf
    </label>

    <div class="w-full bg-gray-200 rounded my-2" id="progressContainer" style="display: none;">
      <div class="h-5 bg-green-500 rounded text-center text-white" id="progressBar" style="width:0%">0%</div>
    </div>

    <button id="mergeBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed">開始合併</button>
  </div>

  <div class="border border-gray-300 rounded-lg p-4 mb-4 shadow">
    <h3 class="font-semibold mb-2">處理日誌</h3>
    <div id="log" class="whitespace-pre-line bg-gray-100 p-2 rounded max-h-52 overflow-y-auto font-mono"></div>
  </div>

  <div class="mt-8 text-center text-gray-600 text-sm">
    使用 Pyodide + pypdf 在瀏覽器中執行，檔案不會離開您的電腦 | <a href="https://github.com/Shen-Ming-Hong/PDF_merge" target="_blank" class="underline">GitHub
      原始碼</a>
  </div>
  <script>
    // 全域變數
    let worker = null;
    const mergeBtn = document.getElementById("mergeBtn");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const progressBar = document.getElementById("progressBar");
    const progressContainer = document.getElementById("progressContainer");

    // 初始化 Worker
    function initWorker() {
      if (worker !== null) {
        worker.terminate();
      }
      worker = new Worker("pdfMergeWorker.js");

      // 設置 worker 事件處理
      worker.onmessage = function (e) {
        const { type, message, data, progress } = e.data;

        switch (type) {
          case 'status':
            log(message);
            if (progress !== undefined) {
              updateProgress(progress);
            }
            break;

          case 'log':
            log(message);
            break;

          case 'initialized':
            mergeBtn.disabled = false;
            break;

          case 'error':
            log(`❌ ${message}`);
            console.error(message);
            mergeBtn.disabled = false;
            break;

          case 'result':
            handleMergeResult(data);
            break;
        }
      };

      worker.onerror = function (error) {
        log(`❌ Worker 錯誤: ${error.message}`);
        console.error(error);
        mergeBtn.disabled = false;
      };

      // 初始化 Pyodide
      worker.postMessage({ type: 'init' });
    }

    // 處理合併結果
    function handleMergeResult(outputBytes) {
      try {
        // 獲取輸出檔名
        const outputName = document.getElementById("outputFileName").value.trim() || "merged_document";

        // 建立 Blob 並下載
        const blob = new Blob([outputBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${outputName}.pdf`;

        // 觸發下載
        a.click();
        URL.revokeObjectURL(url);
        log(`🎉 合併完成！檔案已下載: ${outputName}.pdf (${formatFileSize(blob.size)})`);
      } catch (error) {
        log(`❌ 下載失敗: ${error.message}`);
        console.error(error);
      } finally {
        mergeBtn.disabled = false;
        updateProgress(100);
      }
    }

    // 已選擇的檔案清單，可調整順序
    let selectedFiles = [];

    // 渲染檔案清單，加入上下移動按鈕
    function renderFileList() {
      fileList.innerHTML = "";
      selectedFiles.forEach((file, index) => {
        const li = document.createElement("li");
        li.className = "flex items-center mb-1";

        const text = document.createElement("span");
        text.className = "flex-1";
        text.textContent = `${index + 1}. ${file.name} (${formatFileSize(file.size)})`;

        const upBtn = document.createElement("button");
        upBtn.textContent = "↑";
        upBtn.className = "px-2";
        upBtn.disabled = index === 0;
        upBtn.addEventListener("click", () => moveFile(index, -1));

        const downBtn = document.createElement("button");
        downBtn.textContent = "↓";
        downBtn.className = "px-2";
        downBtn.disabled = index === selectedFiles.length - 1;
        downBtn.addEventListener("click", () => moveFile(index, 1));

        li.appendChild(text);
        li.appendChild(upBtn);
        li.appendChild(downBtn);
        fileList.appendChild(li);
      });
    }

    // 移動檔案位置
    function moveFile(index, offset) {
      const newIndex = index + offset;
      if (newIndex < 0 || newIndex >= selectedFiles.length) return;
      const tmp = selectedFiles[index];
      selectedFiles[index] = selectedFiles[newIndex];
      selectedFiles[newIndex] = tmp;
      renderFileList();
    }

    // 選擇檔案事件
    fileInput.addEventListener("change", () => {
      selectedFiles = Array.from(fileInput.files);
      renderFileList();
    });

    // 合併按鈕事件
    mergeBtn.addEventListener("click", async () => {
      const files = selectedFiles;
      if (!files.length) {
        alert("請先選擇至少 1 個 PDF！");
        return;
      }

      mergeBtn.disabled = true;
      progressContainer.style.display = "block";
      updateProgress(0);
      log(`⌛ 開始處理 ${files.length} 份檔案...`);

      try {
        // 準備檔案資料
        const fileData = [];
        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          log(`⌛ 讀取檔案: ${f.name}`);
          const data = new Uint8Array(await f.arrayBuffer());
          fileData.push({
            name: f.name,
            data: data
          });
          updateProgress((i + 1) / files.length * 30);
        }        // 發送合併請求至 Worker
        worker.postMessage({          type: 'merge',
          data: {
            files: fileData
          }
        });

      } catch (error) {
        log(`❌ 檔案處理失敗: ${error.message}`);
        console.error(error);
        mergeBtn.disabled = false;
      }
    });

    // 輔助函數
    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateProgress(percent) {
      progressBar.style.width = `${percent}%`;
      progressBar.textContent = `${Math.round(percent)}%`;
      progressContainer.style.display = "block";
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
    }

    // 啟動應用
    initWorker();  </script>

  <script>
    // 註冊 Service Worker 以提供離線功能
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            console.log('Service Worker 註冊成功，範圍: ', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker 註冊失敗: ', error);
          });
      });
    }
  </script>
</body>

</html>