<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF åˆä½µå·¥å…· | Pyodide + pypdf</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="font-sans max-w-3xl mx-auto p-4 leading-relaxed">
  <h1 class="text-2xl font-bold mb-2">PDF åˆä½µå·¥å…·</h1>
  <p class="mb-4 text-gray-700">å®Œå…¨é›¢ç·šçš„ç€è¦½å™¨ç«¯ PDF åˆä½µå·¥å…·ï¼Œæ‚¨çš„æª”æ¡ˆä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</p>

  <div class="border border-gray-300 rounded-lg p-4 mb-4 shadow">
    <h3 class="font-semibold mb-2">1. é¸æ“‡è¦åˆä½µçš„ PDF æª”æ¡ˆ</h3>
    <input id="fileInput" class="mb-2" type="file" accept="application/pdf" multiple>
    <ul id="fileList" class="list-none my-2 p-0"></ul>
    <h3 class="font-semibold mb-2">2. åˆä½µé¸é …</h3>
    <label class="block mb-2">
      <input type="text" id="outputFileName" value="merged_document" placeholder="è¼¸å‡ºæª”å" class="border rounded px-2 py-1 mr-1">
      .pdf
    </label>

    <div class="w-full bg-gray-200 rounded my-2" id="progressContainer" style="display: none;">
      <div class="h-5 bg-green-500 rounded text-center text-white" id="progressBar" style="width:0%">0%</div>
    </div>

    <button id="mergeBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed">é–‹å§‹åˆä½µ</button>
  </div>

  <div class="border border-gray-300 rounded-lg p-4 mb-4 shadow">
    <h3 class="font-semibold mb-2">è™•ç†æ—¥èªŒ</h3>
    <div id="log" class="whitespace-pre-line bg-gray-100 p-2 rounded max-h-52 overflow-y-auto font-mono"></div>
  </div>

  <div class="mt-8 text-center text-gray-600 text-sm">
    ä½¿ç”¨ Pyodide + pypdf åœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œï¼Œæª”æ¡ˆä¸æœƒé›¢é–‹æ‚¨çš„é›»è…¦ | <a href="https://github.com/Shen-Ming-Hong/PDF_merge" target="_blank" class="underline">GitHub
      åŸå§‹ç¢¼</a>
  </div>
  <script>
    // å…¨åŸŸè®Šæ•¸
    let worker = null;
    const mergeBtn = document.getElementById("mergeBtn");
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");
    const progressBar = document.getElementById("progressBar");
    const progressContainer = document.getElementById("progressContainer");

    // åˆå§‹åŒ– Worker
    function initWorker() {
      if (worker !== null) {
        worker.terminate();
      }
      worker = new Worker("pdfMergeWorker.js");

      // è¨­ç½® worker äº‹ä»¶è™•ç†
      worker.onmessage = function (e) {
        const { type, message, data, progress } = e.data;

        switch (type) {
          case 'status':
            log(message);
            if (progress !== undefined) {
              updateProgress(progress);
            }
            break;

          case 'log':
            log(message);
            break;

          case 'initialized':
            mergeBtn.disabled = false;
            break;

          case 'error':
            log(`âŒ ${message}`);
            console.error(message);
            mergeBtn.disabled = false;
            break;

          case 'result':
            handleMergeResult(data);
            break;
        }
      };

      worker.onerror = function (error) {
        log(`âŒ Worker éŒ¯èª¤: ${error.message}`);
        console.error(error);
        mergeBtn.disabled = false;
      };

      // åˆå§‹åŒ– Pyodide
      worker.postMessage({ type: 'init' });
    }

    // è™•ç†åˆä½µçµæœ
    function handleMergeResult(outputBytes) {
      try {
        // ç²å–è¼¸å‡ºæª”å
        const outputName = document.getElementById("outputFileName").value.trim() || "merged_document";

        // å»ºç«‹ Blob ä¸¦ä¸‹è¼‰
        const blob = new Blob([outputBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${outputName}.pdf`;

        // è§¸ç™¼ä¸‹è¼‰
        a.click();
        URL.revokeObjectURL(url);
        log(`ğŸ‰ åˆä½µå®Œæˆï¼æª”æ¡ˆå·²ä¸‹è¼‰: ${outputName}.pdf (${formatFileSize(blob.size)})`);
      } catch (error) {
        log(`âŒ ä¸‹è¼‰å¤±æ•—: ${error.message}`);
        console.error(error);
      } finally {
        mergeBtn.disabled = false;
        updateProgress(100);
      }
    }

    // å·²é¸æ“‡çš„æª”æ¡ˆæ¸…å–®ï¼Œå¯èª¿æ•´é †åº
    let selectedFiles = [];

    // æ¸²æŸ“æª”æ¡ˆæ¸…å–®ï¼ŒåŠ å…¥ä¸Šä¸‹ç§»å‹•æŒ‰éˆ•
    function renderFileList() {
      fileList.innerHTML = "";
      selectedFiles.forEach((file, index) => {
        const li = document.createElement("li");
        li.className = "flex items-center mb-1";

        const text = document.createElement("span");
        text.className = "flex-1";
        text.textContent = `${index + 1}. ${file.name} (${formatFileSize(file.size)})`;

        const upBtn = document.createElement("button");
        upBtn.textContent = "â†‘";
        upBtn.className = "px-2";
        upBtn.disabled = index === 0;
        upBtn.addEventListener("click", () => moveFile(index, -1));

        const downBtn = document.createElement("button");
        downBtn.textContent = "â†“";
        downBtn.className = "px-2";
        downBtn.disabled = index === selectedFiles.length - 1;
        downBtn.addEventListener("click", () => moveFile(index, 1));

        li.appendChild(text);
        li.appendChild(upBtn);
        li.appendChild(downBtn);
        fileList.appendChild(li);
      });
    }

    // ç§»å‹•æª”æ¡ˆä½ç½®
    function moveFile(index, offset) {
      const newIndex = index + offset;
      if (newIndex < 0 || newIndex >= selectedFiles.length) return;
      const tmp = selectedFiles[index];
      selectedFiles[index] = selectedFiles[newIndex];
      selectedFiles[newIndex] = tmp;
      renderFileList();
    }

    // é¸æ“‡æª”æ¡ˆäº‹ä»¶
    fileInput.addEventListener("change", () => {
      selectedFiles = Array.from(fileInput.files);
      renderFileList();
    });

    // åˆä½µæŒ‰éˆ•äº‹ä»¶
    mergeBtn.addEventListener("click", async () => {
      const files = selectedFiles;
      if (!files.length) {
        alert("è«‹å…ˆé¸æ“‡è‡³å°‘ 1 å€‹ PDFï¼");
        return;
      }

      mergeBtn.disabled = true;
      progressContainer.style.display = "block";
      updateProgress(0);
      log(`âŒ› é–‹å§‹è™•ç† ${files.length} ä»½æª”æ¡ˆ...`);

      try {
        // æº–å‚™æª”æ¡ˆè³‡æ–™
        const fileData = [];
        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          log(`âŒ› è®€å–æª”æ¡ˆ: ${f.name}`);
          const data = new Uint8Array(await f.arrayBuffer());
          fileData.push({
            name: f.name,
            data: data
          });
          updateProgress((i + 1) / files.length * 30);
        }        // ç™¼é€åˆä½µè«‹æ±‚è‡³ Worker
        worker.postMessage({          type: 'merge',
          data: {
            files: fileData
          }
        });

      } catch (error) {
        log(`âŒ æª”æ¡ˆè™•ç†å¤±æ•—: ${error.message}`);
        console.error(error);
        mergeBtn.disabled = false;
      }
    });

    // è¼”åŠ©å‡½æ•¸
    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateProgress(percent) {
      progressBar.style.width = `${percent}%`;
      progressBar.textContent = `${Math.round(percent)}%`;
      progressContainer.style.display = "block";
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
    }

    // å•Ÿå‹•æ‡‰ç”¨
    initWorker();  </script>

  <script>
    // è¨»å†Š Service Worker ä»¥æä¾›é›¢ç·šåŠŸèƒ½
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            console.log('Service Worker è¨»å†ŠæˆåŠŸï¼Œç¯„åœ: ', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker è¨»å†Šå¤±æ•—: ', error);
          });
      });
    }
  </script>
</body>

</html>